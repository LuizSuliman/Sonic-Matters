<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem Vindo! | Sonic Matters</title>
    <script src="../js/funcoes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="shortcut icon" href="../assets/img/sonic_icon.png" type="image/x-icon">
</head>
<body onload="validarSessao()">
    <div class="header darker">
        <div class="container">
            <a href="../index.html">
                <img src="../assets/img/sonic_matters_logo_white_text_eyes.png" alt="Logo" class="navbar-logo">
            </a>
            <div class="navbar">
                <a href="portal.html" id="navbar-current">Portal</a>
                <a href="sonic_awards.html">SONIC AWARDS</a>
                <a href="chaos_quiz.html">CHAOS QUIZ</a>
            </div>
            <div class="navbar-profile">
                <span id="b_usuario">usuário</span>
                <div class="dropdown-content">
                    <a href="../login.html" onclick="limparSessao()">Sair</a>
                </div>
            </div>
        </div>
    </div>

    
    <div class="votes">
        <div class="container">
            <div class="votes-content">
                <h1 class="the">SONIC AWARDS</h1>
                <h2>Expresse sua opinião sobre a franquia Sonic The Hedgehog através do seu voto!</h2>
                <div class="btns-dash">
                    <!-- O gráfico é chamado de acordo com o id (fkVotacao) do banco  -->
                    <button class="btn-chart btn-blue" onclick="exibirVotacao(10)" id="btnVotacao10">Melhor Personagem</button>
                    <button class="btn-chart btn-white" onclick="exibirVotacao(11)" id="btnVotacao11">Melhor Jogo</button>
                    <button class="btn-chart btn-white" onclick="exibirVotacao(12)" id="btnVotacao12">Melhor Era</button>
                    <button class="btn-chart btn-white" onclick="exibirVotacao(13)" id="btnVotacao13">Melhor Trilha Sonora</button>
                </div>
                <div id="graficos">
                    <div id="grafico10" class="display-block">
                        <div id="vote-table-container-10">
                            Clique sobre um personagem para votar:  
                            <table class="vote-table">
                                <tr>
                                    <td onclick="registrarVoto('Sonic', 10)">
                                        <img src="../assets/img/sonic_char.png" alt="Sonic">
                                        <br>
                                        Sonic
                                    </td>
                                    <td onclick="registrarVoto('Tails', 10)">
                                        <img src="../assets/img/tails_char.png" alt="Tails">
                                        <br>
                                        Tails
                                    </td>
                                    <td onclick="registrarVoto('Knuckles', 10)">
                                        <img src="../assets/img/knuckles_char.png" alt="Knuckles">
                                        <br>
                                        Knuckles
                                    </td>
                                    <td onclick="registrarVoto('Amy', 10)">
                                        <img src="../assets/img/amy_char.png" alt="Amy">
                                        <br>
                                        Amy
                                    </td>
                                    <td onclick="registrarVoto('Blaze', 10)">
                                        <img src="../assets/img/blaze_char.png" alt="Blaze">
                                        <br>
                                        Blaze
                                    </td>
                                </tr>
                                <tr>
                                    <td onclick="registrarVoto('Shadow', 10)">
                                        <img src="../assets/img/shadow_char.png" alt="Shadow">
                                        <br>
                                        Shadow
                                    </td>
                                    <td onclick="registrarVoto('Silver', 10)">
                                        <img src="../assets/img/silver_char.png" alt="Silver">
                                        <br>
                                        Silver
                                    </td>
                                    <td onclick="registrarVoto('Big', 10)">
                                        <img src="../assets/img/big_char.png" alt="Big">
                                        <br>
                                        Big
                                    </td>
                                    <td onclick="registrarVoto('Cream', 10)">
                                        <img src="../assets/img/cream_char.png" alt="Cream">
                                        <br>
                                        Cream
                                    </td>
                                    <td onclick="registrarVoto('Vector', 10)">
                                        <img src="../assets/img/vector_char.png" alt="Vector">
                                        <br>
                                        Vector
                                    </td>
                                </tr>
                                <tr>
                                    <td onclick="registrarVoto('Sticks', 10)">
                                        <img src="../assets/img/sticks_char.png" alt="Sticks">
                                        <br>
                                        Sticks
                                    </td>
                                    <td onclick="registrarVoto('Rouge', 10)">
                                        <img src="../assets/img/rouge_char.png" alt="Rouge">
                                        <br>
                                        Rouge
                                    </td>
                                    <td onclick="registrarVoto('Omega', 10)">
                                        <img src="../assets/img/omega_char.png" alt="Omega">
                                        <br>
                                        Omega
                                    </td>
                                    <td onclick="registrarVoto('Dr. Eggman', 10)">
                                        <img src="../assets/img/eggman_char.png" alt="Dr. Eggman">
                                        <br>
                                        Dr. Eggman
                                    </td>
                                    <td onclick="registrarVoto('Metal Sonic', 10)">
                                        <img src="../assets/img/metal_char.png" alt="Metal Sonic">
                                        <br>
                                        Metal Sonic
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div id="graph10" style="display: none;">
                            <canvas id="myChartCanvas10"></canvas>
                        </div>
                    </div>
            
                    <div id="grafico11" class="display-none">
                        <div id="vote-table-container-11">
                            Clique sobre um jogo para votar:  
                            <table class="vote-table">
                                <tr>
                                    <td onclick="registrarVoto('Sonic 1', 11)">
                                        <img src="../assets/img/sonic1.jpg" alt="Sonic 1">
                                        <br>
                                        Sonic 1
                                    </td>
                                    <td onclick="registrarVoto('Sonic 2', 11)">
                                        <img src="../assets/img/sonic2.jpg" alt="Sonic 2">
                                        <br>
                                        Sonic 2
                                    </td>
                                    <td onclick="registrarVoto('Sonic CD', 11)">
                                        <img src="../assets/img/sonic_cd.jpg" alt="Sonic CD">
                                        <br>
                                        Sonic CD
                                    </td>
                                    <td onclick="registrarVoto('Sonic 3 & Knuckles', 11)">
                                        <img src="../assets/img/sonic3.jpg" alt="Sonic 3 & Knuckles">
                                        <br>
                                        Sonic 3 & Knuckles
                                    </td>
                                    <td onclick="registrarVoto('Sonic Adventure', 11)">
                                        <img src="../assets/img/sonic_adventure.jpg" alt="Sonic Adventure">
                                        <br>
                                        Sonic Adventure
                                    </td>
                                </tr>
                                <tr>
                                    <td onclick="registrarVoto('Sonic Adventure 2', 11)">
                                        <img src="../assets/img/sonic_adventure2.jpg" alt="Sonic Adventure 2">
                                        <br>
                                        Sonic Adventure 2
                                    </td>
                                    <td onclick="registrarVoto('Sonic Heroes', 11)">
                                        <img src="../assets/img/sonic_heroes.jpg" alt="Sonic Heroes">
                                        <br>
                                        Sonic Heroes
                                    </td>
                                    <td onclick="registrarVoto('Sonic 2006', 11)">
                                        <img src="../assets/img/sonic06.jpg" alt="Sonic 2006">
                                        <br>
                                        Sonic 2006
                                    </td>
                                    <td onclick="registrarVoto('Sonic Unleashed', 11)">
                                        <img src="../assets/img/sonic_unleashed.jpg" alt="Sonic Unleashed">
                                        <br>
                                        Sonic Unleashed
                                    </td>
                                    <td onclick="registrarVoto('Sonic Colors', 11)">
                                        <img src="../assets/img/sonic_colors.jpg" alt="Sonic Colors">
                                        <br>
                                        Sonic Colors
                                    </td>
                                </tr>
                                <tr>
                                    <td onclick="registrarVoto('Sonic Generations', 11)">
                                        <img src="../assets/img/sonic_generations.jpg" alt="Sonic Generations">
                                        <br>
                                        Sonic Generations
                                    </td>
                                    <td onclick="registrarVoto('Sonic Lost World', 11)">
                                        <img src="../assets/img/sonic_lost_world.png" alt="Sonic Lost World">
                                        <br>
                                        Sonic Lost World
                                    </td>
                                    <td onclick="registrarVoto('Sonic Mania', 11)">
                                        <img src="../assets/img/sonic_mania.jpg" alt="Sonic Mania">
                                        <br>
                                        Sonic Mania
                                    </td>
                                    <td onclick="registrarVoto('Sonic Forces', 11)">
                                        <img src="../assets/img/sonic_forces.jpg" alt="Sonic Forces">
                                        <br>
                                        Sonic Forces
                                    </td>
                                    <td onclick="registrarVoto('Sonic Frontiers', 11)">
                                        <img src="../assets/img/sonic_frontiers.jpg" alt="Sonic Frontiers">
                                        <br>
                                        Sonic Frontiers
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div id="graph11" style="display: none;">
                            <canvas id="myChartCanvas11"></canvas>
                        </div>
                    </div>
            
                    <div id="grafico12" class="display-none">
                        <div id="vote-table-container-12">
                            Clique sobre um dos Sonics para votar na sua respectiva era:  
                            <table class="vote-table">
                                <tr>
                                    <td onclick="registrarVoto('Classic', 12)">
                                        <img src="../assets/img/classic_sonic.png" alt="Classic">
                                        <br>
                                        Classic
                                    </td>
                                    <td onclick="registrarVoto('Saturn', 12)">
                                        <img src="../assets/img/saturn_sonic.png" alt="Saturn">
                                        <br>
                                        Saturn
                                    </td>
                                    <td onclick="registrarVoto('Adventure', 12)">
                                        <img src="../assets/img/adventure_sonic.png" alt="Adventure">
                                        <br>
                                        Adventure
                                    </td>
                                    <td onclick="registrarVoto('Modern', 12)">
                                        <img src="../assets/img/modern_sonic.png" alt="Modern">
                                        <br>
                                        Modern
                                    </td>
                                    <td onclick="registrarVoto('Open Zone', 12)">
                                        <img src="../assets/img/open_sonic.png" alt="Open Zone">
                                        <br>
                                        Open Zone
                                    </td>
                                </tr>
                                <tr>
                                    <td onclick="registrarVoto('Advance', 12)">
                                        <img src="../assets/img/advance_sonic.png" alt="Advance">
                                        <br>
                                        Advance
                                    </td>
                                    <td onclick="registrarVoto('Storybook', 12)">
                                        <img src="../assets/img/storybook_sonic.png" alt="Storybook">
                                        <br>
                                        Storybook
                                    </td>
                                    <td onclick="registrarVoto('Rush', 12)">
                                        <img src="../assets/img/rush_sonic.png" alt="Rush">
                                        <br>
                                        Rush
                                    </td>
                                    <td onclick="registrarVoto('Riders', 12)">
                                        <img src="../assets/img/riders_sonic.png" alt="Riders">
                                        <br>
                                        Riders
                                    </td>
                                    <td onclick="registrarVoto('Boom', 12)">
                                        <img src="../assets/img/boom_sonic.png" alt="Boom">
                                        <br>
                                        Boom
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div id="graph12" style="display: none;">
                            <canvas id="myChartCanvas12"></canvas>
                        </div>
                    </div>
            
                    <div id="grafico13" class="display-none">
                        <div id="vote-table-container-13">
                            Clique sobre um álbum para votar:  
                            <table class="vote-table">
                                <tr>
                                    <td onclick="registrarVoto('Sonic CD', 13)">
                                        <img src="../assets/img/cd_ost.jpg" alt="Sonic CD">
                                        <br>
                                        Sonic CD
                                    </td>
                                    <td onclick="registrarVoto('Sonic R', 13)">
                                        <img src="../assets/img/r_ost.jpg" alt="Sonic R">
                                        <br>
                                        Sonic R
                                    </td>
                                    <td onclick="registrarVoto('Sonic Adventure', 13)">
                                        <img src="../assets/img/adventure_ost.jpg" alt="Sonic Adventure">
                                        <br>
                                        Sonic Adventure
                                    </td>
                                    <td onclick="registrarVoto('Sonic Heroes', 13)">
                                        <img src="../assets/img/heroes_ost.jpg" alt="Sonic Heroes">
                                        <br>
                                        Complete Trinity <br> (Sonic Heroes)
                                    </td>
                                    <td onclick="registrarVoto('Sonic 2006', 13)">
                                        <img src="../assets/img/06_ost.jpg" alt="Sonic 2006">
                                        <br>
                                        Sonic 2006
                                    </td>
                                </tr>
                                <tr>
                                    <td onclick="registrarVoto('Sonic Rush', 13)">
                                        <img src="../assets/img/rush_ost.jpg" alt="Sonic Rush">
                                        <br>
                                        Original Groove Rush <br> (Sonic Rush)
                                    </td>
                                    <td onclick="registrarVoto('Sonic Unleashed', 13)">
                                        <img src="../assets/img/unleashed_ost.jpg" alt="Sonic Unleashed">
                                        <br>
                                        Planetary Pieces <br> (Sonic Unleashed)
                                    </td>
                                    <td onclick="registrarVoto('Sonic and The Black Knight', 13)">
                                        <img src="../assets/img/knight_ost.jpg" alt="Sonic and The Black Knight">
                                        <br>
                                        Sonic and The Black Knight
                                    </td>
                                    <td onclick="registrarVoto('Sonic Colors', 13)">
                                        <img src="../assets/img/colors_ost.jpg" alt="Sonic Colors">
                                        <br>
                                        Vivid Sound x Hibrid Colors <br> (Sonic Colors)
                                    </td>
                                    <td onclick="registrarVoto('Sonic Generations', 13)">
                                        <img src="../assets/img/generations_ost.jpg" alt="Sonic Generations">
                                        <br>
                                        Sonic Generations
                                    </td>
                                </tr>
                                <tr>
                                    <td onclick="registrarVoto('Sonic Lost World', 13)">
                                        <img src="../assets/img/lost_ost.jpg" alt="Sonic Lost World">
                                        <br>
                                        Without Boundaries <br> (Sonic Lost World)
                                    </td>
                                    <td onclick="registrarVoto('Sonic Runners', 13)">
                                        <img src="../assets/img/runners_ost.jpg" alt="Sonic Runners">
                                        <br>
                                        Sonic Runners
                                    </td>
                                    <td onclick="registrarVoto('Sonic Mania', 13)">
                                        <img src="../assets/img/mania_ost.jpg" alt="Sonic Mania">
                                        <br>
                                        Sonic Mania
                                    </td>
                                    <td onclick="registrarVoto('Team Sonic Racing', 13)">
                                        <img src="../assets/img/team_ost.jpg" alt="Team Sonic Racing">
                                        <br>
                                        Maximum Overdrive <br> (Team Sonic Racing)
                                    </td>
                                    <td onclick="registrarVoto('Sonic Frontiers', 13)">
                                        <img src="../assets/img/frontiers_ost.jpg" alt="Sonic Frontiers">
                                        <br>
                                        Stillness & Motion <br> (Sonic Frontiers)
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div id="graph13" style="display: none;">
                            <canvas id="myChartCanvas13"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    var meuVoto = ["", "", "", ""];

    let proximaAtualizacao;
    
    window.onload = verificarVoto(sessionStorage.ID_USUARIO);
    
    async function verificarVoto(idUsuario) {
        let todosOsGraficos = document.getElementById("graficos")
        for (let i = 10; i <= (todosOsGraficos.childElementCount + 10); i++) {
            await fetch(`/votacao/voto/${i}/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (votoEncontrado) {
                        if (votoEncontrado == "") {
                            // Não faça nada/mantenha a tabela de opções
                        } else {
                            meuVoto[i - 10] = votoEncontrado[0].escolha;
                            console.log(meuVoto);
                            obterDadosGrafico(i, false);
                        }
                    });
                } else {
                    // Não faça nada/mantenha a tabela de opções
                }
            })
                .catch(function (error) {
                    console.error(`Erro na verificação do voto do usuário! ${error.message}`);
                });
        }
    }

    function capturarVoto(idVotacao, idUsuario) {
        fetch(`/votacao/voto/${idVotacao}/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (votoEncontrado) {
                        meuVoto[idVotacao - 10] = votoEncontrado[0].escolha
                        console.log(meuVoto);
                    }
                );
            return
            } else {
                
            }
        })
            .catch(function (error) {
                console.error(`Erro na verificação do voto do usuário! ${error.message}`);
            });
    }

    function obterDadosGraficos() {
        obterDadosGrafico(10)
        obterDadosGrafico(11)
        obterDadosGrafico(12)
        obterDadosGrafico(13)
    }

    function exibirVotacao(idVotacao) {
        let todosOsGraficos = document.getElementById("graficos")
        for (i = 10; i < (todosOsGraficos.childElementCount + 10); i++) {
            // exibindo - ou não - o gráfico
            let elementoAtual = document.getElementById(`grafico${i}`)
            if (elementoAtual.classList.contains("display-block")) {
                elementoAtual.classList.remove("display-block")
            }
            elementoAtual.classList.add("display-none")
            
            // alterando estilo do botão
            let btnAtual = document.getElementById(`btnVotacao${i}`)
            if (btnAtual.classList.contains("btn-blue")) {
                btnAtual.classList.remove("btn-blue")
            }
            btnAtual.classList.add("btn-white")
        }
        
        // exibindo - ou não - o gráfico
        let graficoExibir = document.getElementById(`grafico${idVotacao}`)
        graficoExibir.classList.remove("display-none")
        graficoExibir.classList.add("display-block")
        
        // alterando estilo do botão
        let btnExibir = document.getElementById(`btnVotacao${idVotacao}`)
        btnExibir.classList.remove("btn-white")
        btnExibir.classList.add("btn-blue")
    }

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico(idVotacao, precisaCapturarVoto) {
        if (precisaCapturarVoto) {
            capturarVoto(idVotacao,  sessionStorage.ID_USUARIO)
        }

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/votacao/ultimas/${idVotacao}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    
                    plotarGrafico(resposta, idVotacao);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idVotacao) {

        let tabelaVoto = document.getElementById(`vote-table-container-${idVotacao}`)
        tabelaVoto.style.display = 'none';

        console.log(idVotacao)
        let graficoAtual = document.getElementById(`graph${idVotacao}`)
        graficoAtual.style.display = 'block';

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Votos',
                data: [],
                borderWidth: 2,
                backgroundColor: [
                    'gold',
                    'silver',
                    'brown',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                    'blue',
                ],
                borderColor: [
                    'white'
                ],
                
            }],
        };

        var options = {
            scales: {
                x: {
                ticks: {
                    color: 'white', // Cor dos ticks do eixo x
                },
                grid: {
                    color: 'transparent', // Cor das linhas de grade do eixo x
                },
                },
                y: {
                ticks: {
                    color: 'white', // Cor dos ticks do eixo y
                },
                grid: {
                    color: 'white', // Cor das linhas de grade do eixo y
                },
                },
            },
            plugins: {
                title: {
                    display: true,
                    text: `Você escolheu: ${meuVoto[idVotacao - 10]}`,
                    font: {
                        size: 18,
                        weight: 'bold',
                        family: 'Arial, sans-serif',
                    },
                    color: 'white',
                },
                legend: {
                display: false, // Oculta a legenda
                },
            },
        };
        
        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.escolha);
            dados.datasets[0].data.push(registro.totalVotos);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: options
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idVotacao}`),
            config
        );
    }

    function registrarVoto(escolha, idVotacao) {
        console.log(escolha, idVotacao);

        fetch("/votacao/registro", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                escolhaServer: escolha,
                idVotacaoServer: idVotacao,
                idUsuarioServer: sessionStorage.ID_USUARIO,
            })
        }).then(function (response) {
            if (response.ok) {
                // capturarVoto(idVotacao, sessionStorage.ID_USUARIO);
                obterDadosGrafico(idVotacao, true)
            } else {
                console.error('Nenhum dado encontrado ou erro na API?');
            }
        })
            .catch(function (error) {
                console.error(`Erro na INSERÇÃO dos dados p/ gráfico: ${error.message}`);
            });
    }
</script>